# Prometheus Stack Values for AI Gateway Production
# kube-prometheus-stack Helm chart configuration

# Global configuration
global:
  scrape_interval: 15s
  evaluation_interval: 15s

# Prometheus configuration
prometheus:
  prometheusSpec:
    retention: 30d
    retentionSize: "50GB"

    resources:
      requests:
        memory: "4Gi"
        cpu: "2"
      limits:
        memory: "8Gi"
        cpu: "4"

    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 100Gi

    # Additional scrape configs for AI Gateway
    additionalScrapeConfigs:
      - job_name: 'litellm'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: litellm
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "4000"
            action: keep

      - job_name: 'agentgateway'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: agentgateway
            action: keep

      - job_name: 'vllm'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: vllm.*
            action: keep

    # Alert manager config
    alertingEndpoints:
      - name: alertmanager-main
        namespace: monitoring
        port: web

# Grafana configuration
grafana:
  enabled: true
  adminPassword: "${GRAFANA_ADMIN_PASSWORD}"

  persistence:
    enabled: true
    size: 10Gi
    storageClassName: gp3

  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"

  # Pre-configured data sources
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://prometheus-prometheus:9090
          isDefault: true
          editable: false
        - name: Jaeger
          type: jaeger
          url: http://jaeger-query:16686
          editable: false
        - name: Loki
          type: loki
          url: http://loki:3100
          editable: false
        - name: PostgreSQL
          type: postgres
          url: ${DATABASE_HOST}:5432
          database: litellm
          user: grafana_readonly
          secureJsonData:
            password: ${DATABASE_PASSWORD}
          editable: false

  # Dashboard provisioning
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
        - name: 'ai-gateway'
          orgId: 1
          folder: 'AI Gateway'
          type: file
          disableDeletion: true
          editable: false
          options:
            path: /var/lib/grafana/dashboards/ai-gateway

  # Dashboard ConfigMaps
  dashboardsConfigMaps:
    ai-gateway: "grafana-dashboards-ai-gateway"

  # Plugins
  plugins:
    - grafana-piechart-panel
    - grafana-clock-panel
    - grafana-worldmap-panel

  # Sidecar for dashboard discovery
  sidecar:
    dashboards:
      enabled: true
      label: grafana_dashboard
      folderAnnotation: grafana_folder
      provider:
        foldersFromFilesStructure: true

# Alert Manager
alertmanager:
  alertmanagerSpec:
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: gp3
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi

    resources:
      requests:
        memory: "256Mi"
        cpu: "100m"
      limits:
        memory: "512Mi"
        cpu: "200m"

  config:
    global:
      resolve_timeout: 5m

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default'
      routes:
        - match:
            severity: critical
          receiver: 'critical'
          continue: true
        - match:
            alertname: BudgetExceeded
          receiver: 'finops'

    receivers:
      - name: 'default'
        slack_configs:
          - api_url: '${SLACK_WEBHOOK_URL}'
            channel: '#alerts'

      - name: 'critical'
        pagerduty_configs:
          - service_key: '${PAGERDUTY_SERVICE_KEY}'

      - name: 'finops'
        slack_configs:
          - api_url: '${SLACK_WEBHOOK_URL}'
            channel: '#finops-alerts'
        email_configs:
          - to: 'finops@example.com'

# Node Exporter
nodeExporter:
  enabled: true

# Kube State Metrics
kubeStateMetrics:
  enabled: true
