# Pod Security Standards for Production
# Using Kubernetes native Pod Security Admission (PSA)

apiVersion: v1
kind: Namespace
metadata:
  name: ai-gateway-production
  labels:
    # Enforce restricted security standard
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/enforce-version: latest
    # Warn on baseline violations
    pod-security.kubernetes.io/warn: restricted
    pod-security.kubernetes.io/warn-version: latest
    # Audit all violations
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/audit-version: latest
---
# Resource Quotas for production namespace
apiVersion: v1
kind: ResourceQuota
metadata:
  name: ai-gateway-quota
  namespace: ai-gateway-production
spec:
  hard:
    # Compute resources
    requests.cpu: "50"
    requests.memory: "100Gi"
    limits.cpu: "100"
    limits.memory: "200Gi"

    # Storage
    requests.storage: "500Gi"
    persistentvolumeclaims: "20"

    # Object counts
    pods: "100"
    services: "50"
    secrets: "100"
    configmaps: "100"

    # Services
    services.loadbalancers: "5"
    services.nodeports: "0"
---
# Limit Ranges for default resource constraints
apiVersion: v1
kind: LimitRange
metadata:
  name: ai-gateway-limits
  namespace: ai-gateway-production
spec:
  limits:
    # Default container limits
    - type: Container
      default:
        cpu: "1"
        memory: "1Gi"
      defaultRequest:
        cpu: "100m"
        memory: "256Mi"
      max:
        cpu: "8"
        memory: "32Gi"
      min:
        cpu: "10m"
        memory: "32Mi"

    # Pod limits
    - type: Pod
      max:
        cpu: "32"
        memory: "128Gi"

    # PVC limits
    - type: PersistentVolumeClaim
      max:
        storage: "100Gi"
      min:
        storage: "1Gi"
---
# Service Account with minimal permissions
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ai-gateway-sa
  namespace: ai-gateway-production
automountServiceAccountToken: false
---
# Role for minimal required permissions
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: ai-gateway-role
  namespace: ai-gateway-production
rules:
  # Read-only access to configmaps and secrets in namespace
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list", "watch"]

  # No cluster-level permissions
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: ai-gateway-rolebinding
  namespace: ai-gateway-production
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: ai-gateway-role
subjects:
  - kind: ServiceAccount
    name: ai-gateway-sa
    namespace: ai-gateway-production
