# Vault Installation and Configuration for AI Gateway
# Includes team-based RBAC policies
apiVersion: v1
kind: Namespace
metadata:
  name: vault
  labels:
    app.kubernetes.io/name: vault
    app.kubernetes.io/part-of: ai-gateway-platform
---
# Vault Helm values as ConfigMap (for reference)
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-helm-values
  namespace: vault
data:
  values.yaml: |
    global:
      enabled: true
      tlsDisable: false

    server:
      enabled: true
      image:
        repository: hashicorp/vault
        tag: "1.15.4"

      # High Availability with Raft
      ha:
        enabled: true
        replicas: 3
        raft:
          enabled: true
          setNodeId: true
          config: |
            ui = true

            listener "tcp" {
              tls_disable = 0
              address = "[::]:8200"
              cluster_address = "[::]:8201"
              tls_cert_file = "/vault/userconfig/vault-tls/tls.crt"
              tls_key_file = "/vault/userconfig/vault-tls/tls.key"
            }

            storage "raft" {
              path = "/vault/data"
              retry_join {
                leader_api_addr = "https://vault-0.vault-internal:8200"
              }
              retry_join {
                leader_api_addr = "https://vault-1.vault-internal:8200"
              }
              retry_join {
                leader_api_addr = "https://vault-2.vault-internal:8200"
              }
            }

            service_registration "kubernetes" {}

      # Resource limits
      resources:
        requests:
          memory: 256Mi
          cpu: 250m
        limits:
          memory: 512Mi
          cpu: 500m

      # Audit logging
      auditStorage:
        enabled: true
        size: 10Gi

      # Data storage
      dataStorage:
        enabled: true
        size: 10Gi
        storageClass: fast-ssd

    # Enable UI
    ui:
      enabled: true
      serviceType: ClusterIP

    # Injector for automatic secret injection
    injector:
      enabled: true
      replicas: 2
      resources:
        requests:
          memory: 64Mi
          cpu: 50m
        limits:
          memory: 128Mi
          cpu: 100m
---
# Service Account for Vault Auth
apiVersion: v1
kind: ServiceAccount
metadata:
  name: vault-auth
  namespace: agentgateway
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: vault-auth-delegator
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:auth-delegator
subjects:
  - kind: ServiceAccount
    name: vault-auth
    namespace: agentgateway
