apiVersion: v1
kind: Namespace
metadata:
  name: database
  labels:
    app.kubernetes.io/name: database
    app.kubernetes.io/part-of: ai-gateway-platform
---
# =============================================================================
# IMPORTANT: Do NOT use this in production!
# =============================================================================
# This is a placeholder secret for development only.
# For production, use one of these options:
#
# Option 1: Sealed Secrets (recommended)
#   See: kubernetes/base/database/sealed-secrets-template.yaml
#   Install: kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.24.0/controller.yaml
#   Generate: kubeseal --format yaml < secret.yaml > sealed-secret.yaml
#
# Option 2: External Secrets Operator
#   Install: helm install external-secrets external-secrets/external-secrets
#   Configure to pull from AWS Secrets Manager, Vault, etc.
#
# Option 3: Kubernetes Secrets with RBAC
#   Create secrets manually: kubectl create secret generic postgresql-secrets ...
#   Ensure secrets are encrypted at rest (EncryptionConfiguration)
#
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: postgresql-secrets
  namespace: database
  annotations:
    # WARNING: Replace this secret before production deployment
    ai-gateway.io/security-level: "development-only"
    ai-gateway.io/requires-rotation: "true"
type: Opaque
stringData:
  # DEVELOPMENT ONLY - Generate secure passwords for production:
  # openssl rand -base64 32
  postgres-password: "CHANGE_ME_postgres_dev_password"
  litellm-password: "CHANGE_ME_litellm_dev_password"
  replication-password: "CHANGE_ME_replication_dev_password"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-init
  namespace: database
data:
  # NOTE: This script uses LITELLM_DB_PASSWORD environment variable
  # which is injected from the postgresql-secrets Secret
  init.sh: |
    #!/bin/bash
    set -e

    # Create LiteLLM database and user using password from environment
    psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname "$POSTGRES_DB" <<-EOSQL
      CREATE DATABASE litellm;
      CREATE USER litellm WITH ENCRYPTED PASSWORD '${LITELLM_DB_PASSWORD}';
      GRANT ALL PRIVILEGES ON DATABASE litellm TO litellm;
    EOSQL

  init.sql: |
    -- This runs after init.sh creates the database and user
    -- Connect to litellm database
    \c litellm;

    -- Connect to litellm database
    \c litellm;

    -- Grant schema permissions
    GRANT ALL ON SCHEMA public TO litellm;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO litellm;
    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO litellm;

    -- Create extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
    CREATE EXTENSION IF NOT EXISTS "pg_stat_statements";

    -- LiteLLM will create its own tables, but we can create indexes for common queries

    -- Create a table for custom cost tracking (optional, for FinOps reporting)
    CREATE TABLE IF NOT EXISTS cost_tracking_daily (
        id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        date DATE NOT NULL,
        user_id VARCHAR(255),
        team_id VARCHAR(255),
        model VARCHAR(255) NOT NULL,
        provider VARCHAR(255),
        request_count BIGINT DEFAULT 0,
        input_tokens BIGINT DEFAULT 0,
        output_tokens BIGINT DEFAULT 0,
        total_cost DECIMAL(20, 10) DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(date, user_id, team_id, model)
    );

    CREATE INDEX idx_cost_tracking_date ON cost_tracking_daily(date);
    CREATE INDEX idx_cost_tracking_user ON cost_tracking_daily(user_id);
    CREATE INDEX idx_cost_tracking_team ON cost_tracking_daily(team_id);
    CREATE INDEX idx_cost_tracking_model ON cost_tracking_daily(model);

    -- Create a table for budget alerts history
    CREATE TABLE IF NOT EXISTS budget_alerts (
        id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
        user_id VARCHAR(255),
        team_id VARCHAR(255),
        alert_type VARCHAR(50) NOT NULL,
        threshold_percent DECIMAL(5, 2),
        current_spend DECIMAL(20, 10),
        budget_limit DECIMAL(20, 10),
        message TEXT,
        acknowledged BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    CREATE INDEX idx_budget_alerts_user ON budget_alerts(user_id);
    CREATE INDEX idx_budget_alerts_created ON budget_alerts(created_at);
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
  namespace: database
  labels:
    app.kubernetes.io/name: postgresql
spec:
  serviceName: postgresql
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgresql
    spec:
      containers:
        - name: postgresql
          image: postgres:16-alpine
          ports:
            - containerPort: 5432
              name: postgresql
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secrets
                  key: postgres-password
            - name: LITELLM_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgresql-secrets
                  key: litellm-password
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
            - name: init-scripts
              mountPath: /docker-entrypoint-initdb.d
          resources:
            requests:
              cpu: 500m
              memory: 1Gi
            limits:
              cpu: 2000m
              memory: 4Gi
          livenessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            exec:
              command:
                - pg_isready
                - -U
                - postgres
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
      volumes:
        - name: init-scripts
          configMap:
            name: postgresql-init
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        storageClassName: fast-ssd
---
apiVersion: v1
kind: Service
metadata:
  name: postgresql
  namespace: database
  labels:
    app.kubernetes.io/name: postgresql
spec:
  type: ClusterIP
  ports:
    - port: 5432
      targetPort: 5432
      name: postgresql
  selector:
    app.kubernetes.io/name: postgresql
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: postgresql-network-policy
  namespace: database
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: postgresql
  policyTypes:
    - Ingress
  ingress:
    # Allow from LiteLLM
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: litellm
      ports:
        - protocol: TCP
          port: 5432
    # Allow from FinOps services
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: finops
      ports:
        - protocol: TCP
          port: 5432
