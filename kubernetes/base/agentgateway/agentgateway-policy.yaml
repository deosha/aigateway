apiVersion: v1
kind: ConfigMap
metadata:
  name: agentgateway-cedar-policies
  labels:
    app: agentgateway
data:
  # Cedar policy definitions for RBAC

  entities.json: |
    [
      {
        "uid": { "type": "Role", "id": "admin" },
        "attrs": { "level": 100 }
      },
      {
        "uid": { "type": "Role", "id": "developer" },
        "attrs": { "level": 50 }
      },
      {
        "uid": { "type": "Role", "id": "readonly" },
        "attrs": { "level": 10 }
      },
      {
        "uid": { "type": "Model", "id": "gpt-4o" },
        "attrs": { "provider": "openai", "tier": "premium" }
      },
      {
        "uid": { "type": "Model", "id": "claude-3-5-sonnet-20241022" },
        "attrs": { "provider": "anthropic", "tier": "premium" }
      },
      {
        "uid": { "type": "Model", "id": "llama-3.1-70b" },
        "attrs": { "provider": "vllm", "tier": "standard" }
      }
    ]

  policies.cedar: |
    // Admin policies - full access
    permit (
      principal in Role::"admin",
      action == Action::"invoke_model",
      resource
    );

    permit (
      principal in Role::"admin",
      action == Action::"invoke_tool",
      resource
    );

    permit (
      principal in Role::"admin",
      action in [Action::"register_agent", Action::"discover_agents", Action::"send_message"],
      resource
    );

    // Developer policies - standard access
    permit (
      principal in Role::"developer",
      action == Action::"invoke_model",
      resource
    ) when {
      resource.tier == "standard"
    };

    permit (
      principal in Role::"developer",
      action == Action::"invoke_model",
      resource
    ) when {
      resource.tier == "premium" && context.remaining_budget > 0
    };

    permit (
      principal in Role::"developer",
      action == Action::"invoke_tool",
      resource
    ) unless {
      resource.category == "admin"
    };

    permit (
      principal in Role::"developer",
      action in [Action::"discover_agents", Action::"send_message"],
      resource
    );

    // Readonly policies - limited access
    permit (
      principal in Role::"readonly",
      action == Action::"invoke_model",
      resource
    ) when {
      resource.provider == "vllm" && resource.tier == "standard"
    };

    permit (
      principal in Role::"readonly",
      action == Action::"discover_agents",
      resource
    );

    // Budget enforcement
    forbid (
      principal,
      action == Action::"invoke_model",
      resource
    ) when {
      context.remaining_budget <= 0 && resource.tier == "premium"
    };
