# =============================================================================
# AI Gateway Platform - Docker Compose
# =============================================================================
# Portable configuration for any OS and environment
#
# Usage:
#   Development (minimal):  docker compose up -d
#   Full stack:             docker compose --profile full up -d
#   With observability:     docker compose --profile observability up -d
#   With local models:      docker compose --profile local-models up -d
#   Production-like:        docker compose --profile full --profile observability up -d
#
# Profiles:
#   - (default)      : Core services (litellm, postgres, redis, admin)
#   - observability  : Prometheus, Grafana, Jaeger, OTEL
#   - full           : All platform services
#   - local-models   : GPU stub / Ollama support
#   - workflows      : Temporal + workflow engine
#   - experimental   : Policy router, semantic cache
# =============================================================================

services:
  # ===========================================================================
  # CORE SERVICES (Always started)
  # ===========================================================================

  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gateway-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gateway-network
    restart: unless-stopped

  litellm:
    image: ghcr.io/berriai/litellm:main-latest
    container_name: litellm
    ports:
      - "${LITELLM_PORT:-4000}:4000"
    environment:
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-litellm-master-key-dev}
      DATABASE_URL: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      REDIS_HOST: redis
      REDIS_PORT: 6379
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:-}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:-}
      AWS_REGION_NAME: ${AWS_REGION_NAME:-us-east-1}
      AZURE_API_KEY: ${AZURE_API_KEY:-}
      AZURE_API_BASE: ${AZURE_API_BASE:-}
      OTEL_EXPORTER: otlp_http
      OTEL_ENDPOINT: http://otel-collector:4318
    volumes:
      - ./config/litellm/config.yaml:/etc/litellm/config.yaml:ro
    command: ["--config", "/etc/litellm/config.yaml", "--port", "4000"]
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:4000/health/liveliness', timeout=5)"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - gateway-network
    restart: unless-stopped

  admin-api:
    build:
      context: ./src/admin-api
      dockerfile: Dockerfile
    container_name: admin-api
    ports:
      - "${ADMIN_API_PORT:-8086}:8086"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      LITELLM_URL: http://litellm:4000
      LITELLM_MASTER_KEY: ${LITELLM_MASTER_KEY:-sk-litellm-master-key-dev}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY:-change-in-production}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      postgres:
        condition: service_healthy
      litellm:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8086/health', timeout=5)"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - gateway-network
    restart: unless-stopped

  admin-ui:
    build:
      context: ./ui/admin
      dockerfile: Dockerfile
      args:
        VITE_BASE: /
    container_name: admin-ui
    ports:
      - "${ADMIN_UI_PORT:-5173}:80"
    depends_on:
      - admin-api
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:80/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # OBSERVABILITY (Profile: observability)
  # ===========================================================================

  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: otel-collector
    profiles: ["observability", "full"]
    command: ["--config=/etc/otel/config.yaml"]
    volumes:
      - ./config/otel/otel-collector-config.yaml:/etc/otel/config.yaml:ro
    ports:
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
      - "8889:8889"   # Prometheus metrics
    networks:
      - gateway-network
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:v2.50.0
    container_name: prometheus
    profiles: ["observability", "full"]
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.3.0
    container_name: grafana
    profiles: ["observability", "full"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./kubernetes/base/observability/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./config/grafana/datasources.yaml:/etc/grafana/provisioning/datasources/datasources.yaml:ro
    ports:
      - "${GRAFANA_PORT:-3030}:3000"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3
    depends_on:
      - prometheus
    networks:
      - gateway-network
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: jaeger
    profiles: ["observability", "full"]
    environment:
      COLLECTOR_OTLP_ENABLED: "true"
    ports:
      - "${JAEGER_PORT:-16686}:16686"
      - "14268:14268"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:14269/"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # AGENT GATEWAY (Profile: full)
  # ===========================================================================

  agentgateway:
    image: ghcr.io/agentgateway/agentgateway:0.11.0-alpha.18e45de0f30a108df129aeb08d49453ea0527db3
    container_name: agentgateway
    profiles: ["full"]
    ports:
      - "9000:3000"
      - "15000:15000"
    volumes:
      - ./config/agentgateway/config.yaml:/app/config.yaml:ro
      - ./data:/workspace:rw
    command: ["-f", "/app/config.yaml"]
    environment:
      RUST_LOG: info,agentgateway=debug
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4318
      OTEL_SERVICE_NAME: agentgateway
      POSTGRES_CONNECTION_STRING: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      BRAVE_API_KEY: ${BRAVE_API_KEY:-}
      GITHUB_TOKEN: ${GITHUB_TOKEN:-}
    depends_on:
      litellm:
        condition: service_healthy
      postgres:
        condition: service_healthy
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # WORKFLOW ENGINE (Profile: workflows)
  # ===========================================================================

  temporal:
    image: temporalio/auto-setup:1.22
    container_name: temporal
    profiles: ["workflows", "full"]
    ports:
      - "7233:7233"
    environment:
      DB: postgresql
      DB_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PWD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_SEEDS: postgres
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "temporal operator cluster health --address localhost:7233 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    networks:
      - gateway-network
    restart: unless-stopped

  temporal-ui:
    image: temporalio/ui:2.22.0
    container_name: temporal-ui
    profiles: ["workflows", "full"]
    ports:
      - "8088:8080"
    environment:
      TEMPORAL_ADDRESS: temporal:7233
    depends_on:
      - temporal
    networks:
      - gateway-network
    restart: unless-stopped

  workflow-engine:
    build:
      context: ./src/workflow-engine
      dockerfile: Dockerfile
    container_name: workflow-engine
    profiles: ["workflows", "full"]
    ports:
      - "8085:8085"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      LITELLM_URL: http://litellm:4000
      LITELLM_API_KEY: ${LITELLM_MASTER_KEY:-sk-litellm-master-key-dev}
      AGENT_GATEWAY_URL: http://agentgateway:3000
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      postgres:
        condition: service_healthy
      litellm:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8085/health', timeout=5)"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  a2a-runtime:
    build:
      context: ./src/a2a-runtime
      dockerfile: Dockerfile
    container_name: a2a-runtime
    profiles: ["workflows", "full"]
    ports:
      - "8087:8087"
    environment:
      TEMPORAL_HOST: temporal:7233
      TEMPORAL_NAMESPACE: default
      REDIS_URL: redis://redis:6379
      LITELLM_URL: http://litellm:4000
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      - redis
      - temporal
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8087/health', timeout=5)"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # LOCAL MODELS (Profile: local-models)
  # ===========================================================================

  gpu-stub:
    build:
      context: ./src/gpu-stub
      dockerfile: Dockerfile
    container_name: gpu-stub
    profiles: ["local-models", "full"]
    ports:
      - "8090:8000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # EXPERIMENTAL SERVICES (Profile: experimental)
  # ===========================================================================

  policy-router:
    build:
      context: ./src/policy-router
      dockerfile: Dockerfile
    container_name: policy-router
    profiles: ["experimental", "full"]
    ports:
      - "8084:8084"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      REDIS_URL: redis://redis:6379
      PROMETHEUS_URL: http://prometheus:9090
      CEDAR_POLICIES_PATH: /etc/cedar/policies
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    volumes:
      - ./config/agentgateway/policies:/etc/cedar/policies:ro
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8084/health', timeout=5)"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  semantic-cache:
    build:
      context: ./src/semantic-cache
      dockerfile: Dockerfile
    container_name: semantic-cache
    profiles: ["experimental", "full"]
    ports:
      - "8083:8083"
    environment:
      REDIS_URL: redis://redis:6379
      LITELLM_URL: http://litellm:4000
      EMBEDDING_MODEL: text-embedding-3-small
      SIMILARITY_THRESHOLD: "0.92"
      CACHE_TTL_SECONDS: "3600"
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      - redis
      - litellm
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8083/health', timeout=5)"]
      interval: 15s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # FINOPS SERVICES (Profile: finops)
  # ===========================================================================

  cost-predictor:
    build:
      context: ./src/cost-predictor
      dockerfile: Dockerfile
    container_name: cost-predictor
    profiles: ["finops", "full"]
    ports:
      - "8080:8080"
    environment:
      LITELLM_URL: http://litellm:4000
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    networks:
      - gateway-network
    restart: unless-stopped

  budget-webhook:
    build:
      context: ./src/budget-webhook
      dockerfile: Dockerfile
    container_name: budget-webhook
    profiles: ["finops", "full"]
    ports:
      - "8081:8081"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      LITELLM_URL: http://litellm:4000
      COST_PREDICTOR_URL: http://cost-predictor:8080
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      - postgres
      - cost-predictor
    networks:
      - gateway-network
    restart: unless-stopped

  finops-reporter:
    build:
      context: ./src/finops-reporter
      dockerfile: Dockerfile
    container_name: finops-reporter
    profiles: ["finops", "full"]
    ports:
      - "8082:8082"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER:-litellm}:${POSTGRES_PASSWORD:-litellm}@postgres:5432/${POSTGRES_DB:-litellm}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
    depends_on:
      - postgres
    networks:
      - gateway-network
    restart: unless-stopped

  # ===========================================================================
  # INFRASTRUCTURE (Profile: infra)
  # ===========================================================================

  vault:
    image: hashicorp/vault:1.15.4
    container_name: vault
    profiles: ["infra", "full"]
    cap_add:
      - IPC_LOCK
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root-token-for-dev
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    command: server -dev
    volumes:
      - vault-data:/vault/data
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - gateway-network
    restart: unless-stopped

  nginx:
    image: nginx:1.25-alpine
    container_name: nginx
    profiles: ["infra", "full"]
    ports:
      - "${EXTERNAL_HTTP_PORT:-80}:80"
      - "${EXTERNAL_HTTPS_PORT:-443}:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      litellm:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://127.0.0.1:80/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

  landing-ui:
    build:
      context: ./ui/landing
      dockerfile: Dockerfile
    container_name: landing-ui
    ports:
      - "${LANDING_UI_PORT:-9999}:80"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - gateway-network
    restart: unless-stopped

# =============================================================================
# NETWORKS & VOLUMES
# =============================================================================

networks:
  gateway-network:
    driver: bridge

volumes:
  postgres-data:
  redis-data:
  prometheus-data:
  grafana-data:
  vault-data:
